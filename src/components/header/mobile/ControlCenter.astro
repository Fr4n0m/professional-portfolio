---
import { languages, getCurrentLanguage, getLanguageSwitchUrl } from '@i18n/config';
import type { Translations } from '../../../types/translations';

// Obtener el idioma actual
const currentLang = getCurrentLanguage(Astro.url);

// Obtener traducciones
const translations: Translations = Astro.props.translations;
const t = translations.controlCenter;

// Control Center para m√≥vil - Estilo macOS
---

<div class='relative'>
  <!-- Toggle Button -->
  <button
    type='button'
    class='control-center-toggle p-2 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200'
    aria-label='Control Center'
  >
    <svg class='w-5 h-5 text-gray-700 dark:text-gray-300' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
      <!-- Toggle switches icon similar to macOS -->
      <rect x='3' y='4' width='18' height='6' rx='3' stroke-width='2' />
      <circle cx='16' cy='7' r='2' fill='currentColor' />
      <rect x='3' y='14' width='18' height='6' rx='3' stroke-width='2' />
      <circle cx='8' cy='17' r='2' fill='currentColor' />
    </svg>
  </button>
  
  <!-- Control Center Menu -->
  <div
    class='control-center-menu absolute top-full mt-2 right-0 w-80 max-h-[calc(100vh-100px)] bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-200/20 dark:border-gray-700/20 overflow-hidden opacity-0 scale-95 pointer-events-none transition-all duration-300'
  >
    <!-- User Profile Section -->
    <div class='profile-section p-4 border-b border-gray-200 dark:border-gray-700'>
      <div class='flex items-center gap-3'>
        <img
          src='/assets/images/Fr4n0m Photo.webp'
          alt='User photo'
          class='w-12 h-12 rounded-full object-cover'
        />
        <div>
          <p class='font-semibold text-gray-900 dark:text-white'>{t.profile.name}</p>
          <p class='text-sm text-gray-600 dark:text-gray-400'>{t.profile.role}</p>
        </div>
      </div>
    </div>
    
    <!-- Main Panel -->
    <div class='main-panel'>
      <!-- Quick Actions Grid -->
      <div class='p-4 grid grid-cols-2 gap-3 border-b border-gray-200 dark:border-gray-700'>
        <!-- Theme Toggle -->
        <button class='theme-control-btn p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 text-center' data-action='theme'>
          <svg class='w-6 h-6 mx-auto mb-2 text-gray-700 dark:text-gray-300' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z'></path>
          </svg>
          <span class='text-xs text-gray-700 dark:text-gray-300'>{t.quickActions.theme.label}</span>
        </button>
        
        <!-- Language Toggle -->
        <button class='lang-control-btn p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 text-center' data-action='language'>
          <span class='text-2xl mb-2 block'>{languages[currentLang]?.flag || 'üåê'}</span>
          <span class='text-xs text-gray-700 dark:text-gray-300'>{t.quickActions.language.label}</span>
        </button>
      </div>
      
      <!-- Accessibility Settings -->
      <div class='p-4 space-y-3'>
        <h3 class='text-sm font-semibold text-gray-900 dark:text-white mb-3'>{t.accessibility.title}</h3>
        
        <!-- Font Size -->
        <div class='flex items-center justify-between'>
          <span class='text-sm text-gray-700 dark:text-gray-300'>{t.accessibility.fontSize.label}</span>
          <div class='flex items-center gap-2'>
            <button class='font-size-control p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800' data-action='font-decrease'>
              <svg class='w-4 h-4 text-gray-700 dark:text-gray-300' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M18 12H6'></path>
              </svg>
            </button>
            <span class='font-size-value text-sm font-medium px-2 text-gray-900 dark:text-gray-100'>100%</span>
            <button class='font-size-control p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800' data-action='font-increase'>
              <svg class='w-4 h-4 text-gray-700 dark:text-gray-300' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 6v12m6-6H6'></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Contrast -->
        <div class='flex items-center justify-between'>
          <span class='text-sm text-gray-700 dark:text-gray-300'>{t.accessibility.contrast.label}</span>
          <button class='contrast-toggle relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500/30 bg-gray-200 dark:bg-gray-700' aria-pressed="false" data-action='contrast'>
            <span class='sr-only'>{t.accessibility.contrast.toggle}</span>
            <span class='contrast-toggle-handle absolute bg-white rounded-full h-5 w-5 transition-transform translate-x-0.5 transform duration-200 ease-in-out shadow-sm'></span>
          </button>
        </div>
        
        <!-- Animations -->
        <div class='flex items-center justify-between'>
          <span class='text-sm text-gray-700 dark:text-gray-300'>{t.accessibility.animations.label}</span>
          <button class='animations-toggle relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500/30 bg-blue-500 dark:bg-blue-600' aria-pressed="true" data-action='animations' data-enabled='true'>
            <span class='sr-only'>{t.accessibility.animations.toggle}</span>
            <span class='animations-toggle-handle absolute bg-white rounded-full h-5 w-5 transition-transform translate-x-5 transform duration-200 ease-in-out shadow-sm'></span>
          </button>
        </div>
      </div>
      
      <!-- Additional Settings -->
      <div class='p-4 border-t border-gray-200 dark:border-gray-700'>
        <button class='w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200'>
          <span class='text-sm text-gray-700 dark:text-gray-300'>{t.settings.advanced}</span>
        </button>
      </div>
    </div>
    
    <!-- Language Panel (Initially Hidden) -->
    <div class='language-panel hidden'>
      <div class='p-4 border-b border-gray-200 dark:border-gray-700'>
        <div class='flex items-center justify-between'>
          <h3 class='text-sm font-semibold text-gray-900 dark:text-white'>{t.quickActions.language.title}</h3>
          <button class='back-btn p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800'>
            <svg class='w-5 h-5 text-gray-700 dark:text-gray-300' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7'></path>
            </svg>
          </button>
        </div>
      </div>
      <div class='p-4 grid grid-cols-2 gap-2 max-h-96 overflow-y-auto'>
        {Object.entries(languages).map(([code, langInfo]) => {
          const url = getLanguageSwitchUrl(Astro.url, code);
          const isActive = code === currentLang;
          return (
            <a
              href={url}
              class={`p-3 rounded-lg text-center transition-colors duration-200 ${
                isActive 
                  ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' 
                  : 'hover:bg-gray-100 dark:hover:bg-gray-800'
              }`}
            >
              <span class='text-2xl block mb-1'>{langInfo.flag}</span>
              <span class='text-xs text-gray-700 dark:text-gray-300'>{langInfo.nativeName}</span>
            </a>
          );
        })}
      </div>
    </div>
  </div>
</div>

<script>
  import { gsap } from 'gsap';

  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.querySelector('.control-center-toggle');
    const menu = document.querySelector('.control-center-menu');
    const mainPanel = menu?.querySelector('.main-panel');
    const languagePanel = menu?.querySelector('.language-panel');
    
    if (!toggle || !menu || !mainPanel || !languagePanel) return;
    
    let isOpen = false;
    
    // Animar apertura/cierre del men√∫ con GSAP
    const animateMenu = (open) => {
      if (open) {
        // Mostrar primero para animaci√≥n
        menu.classList.remove('pointer-events-none');
        gsap.to(menu, {
          opacity: 1,
          scale: 1,
          duration: 0.3,
          ease: 'back.out(1.7)',
          onStart: () => {
            // Necesario para que la animaci√≥n sea visible
            menu.style.display = 'block';
          }
        });
      } else {
        gsap.to(menu, {
          opacity: 0,
          scale: 0.95,
          duration: 0.2,
          ease: 'power3.in',
          onComplete: () => {
            menu.classList.add('pointer-events-none');
            // Reset to main panel when closing
            mainPanel.classList.remove('hidden');
            languagePanel.classList.add('hidden');
          }
        });
      }
    };
    
    // Toggle menu
    toggle.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      isOpen = !isOpen;
      animateMenu(isOpen);
    });
    
    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!toggle.contains(e.target) && !menu.contains(e.target) && isOpen) {
        isOpen = false;
        animateMenu(false);
      }
    });
    
    // Theme control
    const themeBtn = menu.querySelector('[data-action="theme"]');
    if (themeBtn) {
      themeBtn.addEventListener('click', () => {
        const currentTheme = localStorage.getItem('theme') || 'system';
        const nextTheme = currentTheme === 'light' ? 'dark' : currentTheme === 'dark' ? 'system' : 'light';
        localStorage.setItem('theme', nextTheme);
        
        const isDark = nextTheme === 'dark' || (nextTheme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        document.documentElement.classList.toggle('dark', isDark);
        
        // Update theme button icon
        const svg = themeBtn.querySelector('svg');
        if (svg) {
          if (nextTheme === 'light') {
            svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
          } else if (nextTheme === 'dark') {
            svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
          } else {
            svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>';
          }
        }
      });
    }
    
    // Language control
    const langBtn = menu.querySelector('[data-action="language"]');
    const backBtn = languagePanel.querySelector('.back-btn');
    
    if (langBtn) {
      langBtn.addEventListener('click', () => {
        gsap.to(mainPanel, {
          opacity: 0,
          duration: 0.2,
          onComplete: () => {
            mainPanel.classList.add('hidden');
            languagePanel.classList.remove('hidden');
            gsap.fromTo(languagePanel, 
              { opacity: 0, x: 20 },
              { opacity: 1, x: 0, duration: 0.3 }
            );
          }
        });
      });
    }
    
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        gsap.to(languagePanel, {
          opacity: 0,
          duration: 0.2,
          onComplete: () => {
            languagePanel.classList.add('hidden');
            mainPanel.classList.remove('hidden');
            gsap.fromTo(mainPanel, 
              { opacity: 0, x: -20 },
              { opacity: 1, x: 0, duration: 0.3 }
            );
          }
        });
      });
    }
    
    // Font size controls
    let fontSize = parseInt(localStorage.getItem('fontSize') || '100');
    const fontSizeSpan = menu.querySelector('.font-size-value');
    
    // Apply saved font size on load
    const applyFontSize = (size) => {
      // Update HTML root font size
      document.documentElement.style.fontSize = `${size}%`;
      // Update data attribute for CSS classes
      document.documentElement.setAttribute('data-font-size', size.toString());
      // Update display
      if (fontSizeSpan) fontSizeSpan.textContent = `${size}%`;
      // Save preference
      localStorage.setItem('fontSize', size.toString());
    };
    
    // Initialize font size
    applyFontSize(fontSize);
    
    menu.querySelector('[data-action="font-decrease"]')?.addEventListener('click', () => {
      if (fontSize > 85) {
        fontSize -= 5;
        applyFontSize(fontSize);
        
        // Animaci√≥n de feedback
        gsap.fromTo(fontSizeSpan, 
          { scale: 0.8 },
          { scale: 1, duration: 0.3, ease: 'back.out(1.7)' }
        );
      }
    });
    
    menu.querySelector('[data-action="font-increase"]')?.addEventListener('click', () => {
      if (fontSize < 120) {
        fontSize += 5;
        applyFontSize(fontSize);
        
        // Animaci√≥n de feedback
        gsap.fromTo(fontSizeSpan, 
          { scale: 1.2 },
          { scale: 1, duration: 0.3, ease: 'back.out(1.7)' }
        );
      }
    });
    
    // Contrast toggle - mejorado y accesible
    const contrastToggle = menu.querySelector('[data-action="contrast"]');
    const contrastHandle = contrastToggle?.querySelector('.contrast-toggle-handle');
    
    // Cargar estado de alto contraste guardado
    const loadContrastState = () => {
      const contrastEnabled = localStorage.getItem('high-contrast') === 'true';
      document.documentElement.classList.toggle('high-contrast', contrastEnabled);
      
      if (contrastToggle && contrastHandle) {
        contrastToggle.setAttribute('aria-pressed', contrastEnabled.toString());
        contrastToggle.classList.toggle('bg-blue-500', contrastEnabled);
        contrastToggle.classList.toggle('dark:bg-blue-600', contrastEnabled);
        
        // Actualizamos la posici√≥n del handle
        if (contrastEnabled) {
          contrastHandle.classList.remove('translate-x-0.5');
          contrastHandle.classList.add('translate-x-5');
        } else {
          contrastHandle.classList.add('translate-x-0.5');
          contrastHandle.classList.remove('translate-x-5');
        }
      }
    };
    
    // Inicializar estado
    loadContrastState();
    
    if (contrastToggle && contrastHandle) {
      contrastToggle.addEventListener('click', () => {
        const isPressed = contrastToggle.getAttribute('aria-pressed') === 'true';
        const nextState = !isPressed;
        
        // Guardar preferencia
        localStorage.setItem('high-contrast', nextState.toString());
        
        // Actualizar UI
        contrastToggle.setAttribute('aria-pressed', nextState.toString());
        document.documentElement.classList.toggle('high-contrast', nextState);
        
        // Actualizar estilos visualmente
        contrastToggle.classList.toggle('bg-blue-500', nextState);
        contrastToggle.classList.toggle('dark:bg-blue-600', nextState);
        
        // Animar el handle
        if (nextState) {
          gsap.to(contrastHandle, {
            x: '20px',
            duration: 0.2,
            ease: 'power2.out'
          });
        } else {
          gsap.to(contrastHandle, {
            x: '0px',
            duration: 0.2,
            ease: 'power2.out'
          });
        }
      });
    }
    
    // Animations toggle - mejorado y con integraci√≥n GSAP
    const animationsToggle = menu.querySelector('[data-action="animations"]');
    const animationsHandle = animationsToggle?.querySelector('.animations-toggle-handle');
    
    // Cargar estado de animaciones guardado
    const loadAnimationsState = () => {
      const animationsEnabled = localStorage.getItem('enable-animations') !== 'false'; // Por defecto activado
      document.documentElement.classList.toggle('reduce-motion', !animationsEnabled);
      
      if (animationsToggle && animationsHandle) {
        animationsToggle.setAttribute('aria-pressed', animationsEnabled.toString());
        animationsToggle.dataset.enabled = animationsEnabled.toString();
        animationsToggle.classList.toggle('bg-blue-500', animationsEnabled);
        animationsToggle.classList.toggle('dark:bg-blue-600', animationsEnabled);
        animationsToggle.classList.toggle('bg-gray-200', !animationsEnabled);
        animationsToggle.classList.toggle('dark:bg-gray-700', !animationsEnabled);
        
        // Actualizamos la posici√≥n del handle
        if (animationsEnabled) {
          animationsHandle.classList.add('translate-x-5');
          animationsHandle.classList.remove('translate-x-0.5');
        } else {
          animationsHandle.classList.remove('translate-x-5');
          animationsHandle.classList.add('translate-x-0.5');
        }
      }
      
      // Desactivar animaciones GSAP si es necesario
      if (!animationsEnabled && window.gsap) {
        gsap.globalTimeline.timeScale(0.0001); // Pr√°cticamente congelamos las animaciones
      } else if (window.gsap) {
        gsap.globalTimeline.timeScale(1); // Restauramos la velocidad normal
      }
    };
    
    // Inicializar estado de animaciones
    loadAnimationsState();
    
    if (animationsToggle && animationsHandle) {
      animationsToggle.addEventListener('click', () => {
        const isPressed = animationsToggle.getAttribute('aria-pressed') === 'true';
        const nextState = !isPressed;
        
        // Guardar preferencia
        localStorage.setItem('enable-animations', nextState.toString());
        
        // Actualizar UI
        animationsToggle.setAttribute('aria-pressed', nextState.toString());
        animationsToggle.dataset.enabled = nextState.toString();
        document.documentElement.classList.toggle('reduce-motion', !nextState);
        
        // Actualizar estilos visualmente
        animationsToggle.classList.toggle('bg-blue-500', nextState);
        animationsToggle.classList.toggle('dark:bg-blue-600', nextState);
        animationsToggle.classList.toggle('bg-gray-200', !nextState);
        animationsToggle.classList.toggle('dark:bg-gray-700', !nextState);
        
        // Animar el handle
        if (nextState) {
          gsap.to(animationsHandle, {
            x: '20px',
            duration: 0.2,
            ease: 'power2.out'
          });
        } else {
          gsap.to(animationsHandle, {
            x: '0px',
            duration: 0.2,
            ease: 'power2.out'
          });
        }
        
        // Activar/desactivar animaciones GSAP
        if (!nextState && window.gsap) {
          gsap.globalTimeline.timeScale(0.0001); // Pr√°cticamente congelamos las animaciones
          
          // Notificamos al usuario que se han desactivado las animaciones
          const notification = document.createElement('div');
          notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg';
          notification.style.zIndex = '9999';
          notification.textContent = 'Animaciones desactivadas';
          document.body.appendChild(notification);
          
          // Removemos la notificaci√≥n despu√©s de 2 segundos
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 2000);
        } else if (window.gsap) {
          gsap.globalTimeline.timeScale(1); // Restauramos la velocidad normal
          
          // Notificamos al usuario que se han activado las animaciones
          const notification = document.createElement('div');
          notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg';
          notification.style.zIndex = '9999';
          notification.textContent = 'Animaciones activadas';
          document.body.appendChild(notification);
          
          // Removemos la notificaci√≥n despu√©s de 2 segundos
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 2000);
        }
      });
    }
  });
</script>

<style>
  /* Control Center specific styles */
  .control-center-menu {
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
  }
  
  /* High contrast mode */
  html.high-contrast {
    filter: contrast(1.3) saturate(1.2);
  }
  
  html.high-contrast img,
  html.high-contrast video {
    filter: contrast(1.1) saturate(1.2);
  }
  
  html.high-contrast .control-center-menu {
    background-color: rgb(255 255 255 / 0.98);
  }
  
  html.dark.high-contrast .control-center-menu {
    background-color: rgb(17 24 39 / 0.98);
  }
  
  html.high-contrast button,
  html.high-contrast a {
    outline: 1px solid transparent;
  }
  
  html.high-contrast button:focus,
  html.high-contrast a:focus {
    outline-color: #1F429F;
  }
  
  html.dark.high-contrast button:focus,
  html.dark.high-contrast a:focus {
    outline-color: #facc15;
  }
  
  /* Smooth transitions for toggles */
  .contrast-toggle-handle,
  .animations-toggle-handle {
    will-change: transform;
  }
  
  .translate-x-5 {
    transform: translateX(1.25rem);
  }
  
  /* Reduce motion */
  html.reduce-motion * {
    animation-duration: 0.0001s !important;
    transition-duration: 0.0001s !important;
    scroll-behavior: auto !important;
  }
  
  html.reduce-motion .gsap-fade-in,
  html.reduce-motion .gsap-stagger,
  html.reduce-motion .gsap-stagger-item,
  html.reduce-motion .gsap-scale {
    opacity: 1 !important;
    transform: none !important;
    transition: none !important;
  }
  
  /* Fixes for toggle components appearance */
  .contrast-toggle,
  .animations-toggle {
    transition: background-color 0.3s ease;
  }
  
  /* Scrollbar for language panel */
  .language-panel .grid::-webkit-scrollbar {
    width: 6px;
  }
  
  .language-panel .grid::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .language-panel .grid::-webkit-scrollbar-thumb {
    background: rgba(128, 128, 128, 0.3);
    border-radius: 3px;
  }
  
  .language-panel .grid::-webkit-scrollbar-thumb:hover {
    background: rgba(128, 128, 128, 0.5);
  }
  
  /* Peque√±a animaci√≥n de feedback para los botones */
  button:active:not(.contrast-toggle):not(.animations-toggle) {
    transform: scale(0.97);
  }
</style>
